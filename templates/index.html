<!DOCTYPE html>
<html>
<head>
    <title>Dota Analysis</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
</head>
<body>
    <h2>Dota Analysis</h2>

    <!-- Mode Selection -->
    <label for="mode">Mode:</label>
    <select id="mode">
        <option value="Hero">Hero</option>
        <option value="Player">Player</option>
    </select>

    <!-- Hero Mode Selection -->
    <div id="hero_mode">
        <label for="player_dropdown">Player ID:</label>
        <select id="player_dropdown"></select>

        <label for="hero_dropdown">Hero:</label>
        <select id="hero_dropdown"></select>

        <label for="duration_dropdown">Duration:</label>
        <select id="duration_dropdown">
            <option value="1_month">1 Month</option>
            <option value="3_months">3 Months</option>
            <option value="6_months" selected>6 Months</option>
            <option value="1_year">1 Year</option>
        </select>
    </div>

    <!-- Player Mode Input -->
    <div id="player_mode" style="display: none;">
        <label for="player_id">Your Account ID:</label>
        <input type="text" id="player_id" placeholder="302004172">

        <label for="others_account_id">Others Account ID:</label>
        <input type="text" id="others_account_id" placeholder="Enter Others Account ID">

        <label for="duration_dropdown_player">Duration:</label>
        <select id="duration_dropdown_player">
            <option value="1_month">1 Month</option>
            <option value="3_months">3 Months</option>
            <option value="6_months">6 Months</option>
            <option value="1_year">1 Year</option>
            <option value="all_time" selected>All Time</option>
        </select>
    </div>

    <button id="fetch_btn">Fetch Data</button>

    <div id="result">
        <!-- Rendered table and summary will go here -->
    </div>

    <script>
        $(document).ready(function() {
            // Store current AJAX request for cancellation
            let currentRequest = null;
            
            // Populate hero and player dropdowns via backend API if needed
            // For demo purpose, hardcoded example options:
            const playerOptions = [302004172, 129213402, 138951493];

            playerOptions.forEach(p => $("#player_dropdown").append(`<option value="${p}">${p}</option>`));
            
            // Fetch hero names from backend
            $.get("/get_heroes", function(data) {
                data.heroes.forEach(hero => {
                    $("#hero_dropdown").append(`<option value="${hero.name}">${hero.name}</option>`);
                });
            });
            
            // Default fill your account ID
            $("#player_id").val("302004172");

            // Function to abort current request
            function abortCurrentRequest() {
                if (currentRequest) {
                    currentRequest.abort();
                    currentRequest = null;
                    $("#result").html("<b>Request cancelled.</b>");
                }
                // Also notify backend to cancel
                $.post("/cancel_request");
            }

            // Mode toggle
            $("#mode").change(function() {
                abortCurrentRequest();
                if ($(this).val() === "Hero") {
                    $("#hero_mode").show();
                    $("#player_mode").hide();
                } else {
                    $("#hero_mode").hide();
                    $("#player_mode").show();
                }
            });

            // Abort request when any dropdown changes
            $("#player_dropdown, #hero_dropdown, #duration_dropdown, #duration_dropdown_player").change(function() {
                abortCurrentRequest();
            });
            
            // Save my account ID when it changes
            $("#player_id").on('input', function() {
                localStorage.setItem('myAccountId', $(this).val());
            });

            // Fetch button click
            $("#fetch_btn").click(function() {
                // Abort any existing request first
                abortCurrentRequest();
                
                // Reset cancellation state before starting new request
                $.post("/reset_cancellation");
                
                let data = { mode: $("#mode").val() };

                if (data.mode === "Hero") {
                    data.player_id = $("#player_dropdown").val();
                    data.hero_name = $("#hero_dropdown").val();
                    data.duration = $("#duration_dropdown").val();
                } else if (data.mode === "Player") {
                    data.player_id = $("#player_id").val();
                    data.other_player_id = $("#others_account_id").val();
                    data.duration = $("#duration_dropdown_player").val();
                }

                // Show loading message
                $("#result").html("<b>Fetching data...</b>");

                // Store the current request
                currentRequest = $.post("/call_function", data, function(response) {
                    if (response.html) {
                        $("#result").html(response.html);
                        $("table.display").DataTable({
                            "paging": true,
                            "searching": true,
                            "ordering": true,
                            "order": [[2, "desc"]]  // Sort by Matches column (index 3) in descending order
                        });
                    } else {
                        $("#result").html("<b>No data returned.</b>");
                    }
                    currentRequest = null;
                }, "json").fail(function(xhr, status, error) {
                    if (status !== 'abort') {
                        $("#result").html("<b>Error calling backend.</b>");
                    }
                    currentRequest = null;
                });
            });
        });
    </script>
</body>
</html>
